<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Breakout</title>
    <script src="//cdn.jsdelivr.net/phaser/2.6.2/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>

<body>

    <script type="text/javascript">

        var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

        function preload() {
            game.load.image('background', 'assets/background.png');
            game.load.image('racket', 'assets/racket.png');
            game.load.image('ball', 'assets/ball.png');
            game.load.image('brick', 'assets/brick.png');
        }

        // Schläger
        var racket;
        // Ball
        var ball;
        // Anzahl Leben
        var lives = 3;
        // Blöcke
        var bricks;
        // Punkte
        var score = 0;

        // Text zur Anzeige der Leben
        var livesText;
        // Text zur Anzeige der Punkte
        var scoreText;
        // Geschwindigkeit des Balls
        var ballSpeed = 200;

        function create() {
            // Physik starten
            game.physics.startSystem(Phaser.Physics.ARCADE);

            // Wir ignorieren die untere Bildschirmkante
            game.physics.arcade.checkCollision.down = false;

            // Schläger erstellen
            racket = game.add.sprite(game.world.centerX, 580, 'racket');
            game.physics.arcade.enable(racket);
            // Gravitation & Impuls wirkt nicht auf den Schläger
            racket.body.immovable = true;
            // Schläger kann nicht aus der Welt bewegt werden
            racket.body.collideWorldBounds = true;

            // Ball erstellen
            ball = game.add.sprite(game.world.centerX, 0, 'ball');
            game.physics.arcade.enable(ball);
            // Ball hat 100% Elastizität und springt perfekt
            ball.body.bounce.y = 1;
            ball.body.bounce.x = 1;

            // Der Ball hat eine zufällige Geschwindigkeit nach rechts oder links
            ball.body.velocity.x = (Phaser.Math.between(0, 2) - 1) * ballSpeed;
            // Der Ball hat eine festgelegte Geschwindigkeit nach unten
            ball.body.velocity.y = ballSpeed;
            // Der Ball kann nicht aus der Welt bewegt werden (außer nach unten)
            ball.body.collideWorldBounds = true;

            // Phaser soll überprüfen, wenn der Ball aus der Welt fällt (ist nur unten möglich)
            ball.checkWorldBounds = true;
            // Wenn der Ball unten aus der Welt fällt, rufe onBallLost() auf
            ball.events.onOutOfBounds.add(onBallLost, this);

            // Text, der die Anzahl der Leben anzeigt
            livesText = game.add.text(650, 550, 'lives: ' + lives, { font: "16px Courier New", fill: "#ffffff", align: "left" });

            // Text, der die Punkte anzeigt
            scoreText = game.add.text(32, 550, 'score: 0', { font: "16px Courier New", fill: "#ffffff", align: "left" });

            // Blöcke erstellen (Gruppe von Objekten)
            bricks = game.add.group();
            // Alle Objekte der Gruppen sollen Physik haben
            bricks.enableBody = true;
            bricks.physicsBodyType = Phaser.Physics.ARCADE;

            for (var y = 0; y < 4; y++) {
                for (var x = 0; x < 15; x++) {
                    var brick = bricks.create(120 + (x * 36), 100 + (y * 52), 'brick');
                    brick.body.bounce.set(1);
                    brick.body.immovable = true;
                }
            }
        }

        function update() {
            // Wurde der Schläger vom Ball getroffen? Falls ja, rufe onBallHitRacket() auf
            game.physics.arcade.collide(ball, racket, onBallHitRacket, null, this);

            // Wurde ein Block von dem Ball getroffen? Falls ja, rufe onBallHitBrick() auf
            game.physics.arcade.collide(ball, bricks, onBallHitBrick, null, this);

            // Vom der Tastatur lesen
            var cursors = game.input.keyboard.createCursorKeys();

            if (cursors.left.isDown) {
                // Links wurde gedrückt, also den Schläger nach links bewegen
                racket.body.velocity.x = -150;
            }
            else if (cursors.right.isDown) {
                // Rechts wurde gedrückt, also den Schläger nach links bewegen
                racket.body.velocity.x = 150;
            } else {
                // Es wurde keine Taste gedrückt, also Schläger anhalten
                racket.body.velocity.x = 0;
            }
        }

        function onBallHitRacket(_ball, _racket) {
            if (_racket.body.velocity.x > 0) {
                // Schläger bewegt sich nach rechts -> Dem Ball einen Impuls nach rechts geben
                _ball.body.velocity.x = Math.min(ballSpeed, _ball.body.velocity.x + 25);
            } else if (_racket.body.velocity.x < 0) {
                // Schläger bewegt sich nach links -> Dem Ball einen Impuls nach links geben
                _ball.body.velocity.x = Math.max(-ballSpeed, _ball.body.velocity.x - 25);
            } else {

            }
        }

        function onBallHitBrick(_ball, brick) {
            // Block löschen
            brick.kill();

            // Punkte erhöhen
            score += 1;
            // Und den Punkte-Text aktualisieren
            scoreText.text = 'score: ' + score;

            if (bricks.countLiving() < 0) {
                // Alle Blöcke wurden zerstört
                allBricksDestroyed();
            }
        }

        function allBricksDestroyed() {
            // Punkte erhöhen
            score += 1000;
            // Geschwindigkeit des Balls erhöhen
            ballSpeed += 25;

            // Jedes Level gibt ein neues Leben
            lives += 1;
            // Und den Text aktualisieren
            livesText.text = 'lives: ' + lives;

            // Alle Blöcke wieder herstellen
            bricks.callAll('revive');
        }

        function onBallLost() {
            // Ball wieder oben starten lassen
            ball.reset(game.world.centerX, 0);
            // Der Ball hat eine zufällige Geschwindigkeit nach rechts oder links
            ball.body.velocity.x = (Phaser.Math.between(0, 2) - 1) * ballSpeed;
            // Der Ball hat eine festgelegte Geschwindigkeit nach unten
            ball.body.velocity.y = ballSpeed;

            // Ein Leben abziehen
            lives--;
            // Und den Text aktualisieren
            livesText.text = 'lives: ' + lives;

            // Wenn keine Leben mehr über sind, dann ist das Spiel aus
            if (lives == 0) {
                gameOver();
            }
        }

        function gameOver() {
            // Ball wieder oben starten lassen
            ball.reset(game.world.centerX, 0);
            // Ball anhalten
            ball.body.velocity.setTo(0, 0);
            // Text anzeigen. Spiel kann durch Neuladen der Seite wieder gestartet werden
            livesText.text = 'Game over :('
        }

    </script>

</body>

</html>